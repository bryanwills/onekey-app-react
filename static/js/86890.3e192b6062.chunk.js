"use strict";(self.webpackChunkweb=self.webpackChunkweb||[]).push([[86890],{567967:(e,t,r)=>{r.d(t,{Xp:()=>a.Xp,yZ:()=>useBrowserAction,Gd:()=>useBrowserBookmarkAction,cS:()=>useBrowserHistoryAction,AO:()=>useBrowserTabActions,AS:()=>a.AS,Do:()=>a.Do,pJ:()=>a.pJ,nD:()=>a.nD});var a=r(603614),n=r(586330),i=r(324586),o=r(946343),l=r.n(o),s=r(230414),u=r(929296),c=r(195309),d=r(972715),b=r(514041),p=r(490343),f=r(310955),y=r(262873),m=r(714178),k=r(971670),v=r(660015),w=r(849726),g=(r(663522),r(730223),r(657355)),D=r(482407),h=r(796151),A=function(e){return e.Valid="Valid",e.InvalidUrl="InvalidUrl",e.NotSupportProtocol="NotSupportProtocol",e.ValidDeeplink="ValidDeeplink",e.InvalidPunycode="InvalidPunycode",e}({});function ownKeys(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,a)}return r}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(r),!0).forEach((function(t){(0,i.A)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):ownKeys(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function _createSuper(e){var t=_isNativeReflectConstruct();return function _createSuperInternal(){var r,a=(0,d.A)(e);if(t){var n=(0,d.A)(this).constructor;r=Reflect.construct(a,arguments,n)}else r=a.apply(this,arguments);return(0,c.A)(this,r)}}function _isNativeReflectConstruct(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(_isNativeReflectConstruct=function(){return!!e})()}var B={};var W="about:blank",S={id:"home",url:W,title:"OneKey",canGoBack:!1,loading:!1,favicon:""},T=function(e){(0,u.A)(ContextJotaiActionsDiscovery,e);var t=_createSuper(ContextJotaiActionsDiscovery);function ContextJotaiActionsDiscovery(...e){var r,i,o,s,u,c,d,b,m;return(r=t.call(this,...e)).setDisplayHomePage=(0,a.q0)((function(e,t,r){t((0,a.QL)(),r)})),r.buildWebTabs=(0,a.q0)((function(e,t,r){var n=e((0,a.cl)()),{data:i,options:o}=r,s=i;if(!Array.isArray(i))throw new Error("setWebTabsWriteAtom: payload must be an array");s&&s.length||(s=[]);var u=function buildWebTabData(e){var t={},r=[];return e.sort((function(e,t){return e.timestamp&&t.timestamp?e.timestamp-t.timestamp:0})),e.forEach((function(e){r.push(e.id),t[e.id]=e})),{data:e,keys:r,map:t}}(s);l()(u.keys,n.keys)&&!o?.forceUpdate||t((0,a.cl)(),{keys:u.keys,tabs:u.data}),t((0,a.GW)(),(function(){return u.map})),f.A.simpleDb.browserTabs.setRawData({tabs:u.data})})),r.refreshTabs=(0,a.q0)((function(e,t){var{tabs:n}=e((0,a.cl)()),i=[...n];r.buildWebTabs.call(t,{data:i,options:{forceUpdate:!0}})})),r.setCurrentWebTab=(0,a.q0)((function(e,t,n){var i=e((0,a.WL)());if(i!==n){r.pauseDappInteraction.call(t,i);var{tabs:o}=e((0,a.cl)()),l=o.findIndex((function(e){return e.id===n}));o.forEach((function(e){e.isActive=!1})),r.buildWebTabs.call(t,{data:[...o]}),-1!==l?(o[l].isActive=!0,t((0,a.WL)(),n),r.resumeDappInteraction.call(t,n)):t((0,a.WL)(),"")}var s=e((0,a.QL)());n&&s&&r.setDisplayHomePage.call(t,!1),n||s||r.setDisplayHomePage.call(t,!0)})),r.addWebTab=(0,a.q0)((function(e,t,n){var i,o=performance.now(),{tabs:l}=e((0,a.cl)());n.id&&n.id!==S.id||(n.id=(0,D.lk)()),n.timestamp=Date.now(),r.buildWebTabs.call(t,{data:[...l,n]}),r.setCurrentWebTab.call(t,null!=(i=n.id)?i:"");var s=performance.now();console.log(`addBlankWebTab took ${s-o} milliseconds.`)})),r.addBlankWebTab=(0,a.q0)((function(e,t){r.addWebTab.call(t,_objectSpread(_objectSpread({},S),{},{isActive:!0}))})),r.setWebTabData=(0,a.q0)((function(e,t,n){var{tabs:i}=e((0,a.cl)()),o=i,l=o.findIndex((function(e){return e.id===n.id}));if(l>-1){var s=o[l];Object.keys(n).forEach((function(e){var t=e,r=n[t];if(void 0!==r&&r!==s[t]){if("title"===t&&!r)return;s[t]=r,"url"===t&&(s.timestamp=Date.now(),"about:blank"===r&&n.id&&(B[n.id]=s.timestamp))}})),o[l]=s,r.buildWebTabs.call(t,{data:o})}})),r.closeWebTab=(0,a.q0)((function(e,t,n){delete v.O3[n];var{tabs:i}=e((0,a.cl)()),o=e((0,a.WL)()),l=i.findIndex((function(e){return e.id===n}));if(-1!==l){var s=i[l].id===o;if(i.splice(l,1),s){var u=l-1;if(u<0&&i.length>0&&(u=0),u>=0){var c=i[u];c.isActive=!0,r.setCurrentWebTab.call(t,c.id)}}}r.buildWebTabs.call(t,{data:[...i]})})),r.closeAllWebTabs=(0,a.q0)((function(e,t){var{tabs:n}=e((0,a.cl)()),i=e((0,a.WL)()),o=n.filter((function(e){return e.isPinned}));o.every((function(e){return e.id!==i}))&&r.setCurrentWebTab.call(t,null);var _loop=function(e){o.find((function(t){return t.id===e}))||delete v.O3[e]};for(var l of Object.getOwnPropertyNames(v.O3))_loop(l);r.buildWebTabs.call(t,{data:o})})),r.setPinnedTab=(0,a.q0)((function(e,t,a){r.setWebTabData.call(t,{id:a.id,isPinned:a.pinned,timestamp:Date.now()}),r.refreshTabs.call(t)})),r.syncBookmark=(0,a.q0)((function(e,t,n){var i=e((0,a.GW)());i&&Object.entries(i).forEach((function([,e]){e.url===n.url&&r.setWebTabData.call(t,{id:e.id,isBookmark:n.isBookmark})}))})),r.getBookmarkData=(0,a.q0)((0,n.A)((function*(){var e;return null!=(e=(yield f.A.simpleDb.browserBookmarks.getRawData())?.data)?e:[]}))),r.buildBookmarkData=(0,a.q0)((function(e,t,r){if(!Array.isArray(r))throw new Error("buildBookmarkData: payload must be an array");f.A.simpleDb.browserBookmarks.setRawData({data:r})})),r.addBrowserBookmark=(0,a.q0)((i=(0,n.A)((function*(e,t,a){if(a.url&&a.url!==S.url){var n=[...(yield r.getBookmarkData.call(t)).filter((function(e){return e.url!==a.url})),{url:a.url,title:a.title}];r.buildBookmarkData.call(t,n),r.syncBookmark.call(t,{url:a.url,isBookmark:!0}),f.A.serviceCloudBackup.requestAutoBackup()}})),function(e,t,r){return i.apply(this,arguments)})),r.removeBrowserBookmark=(0,a.q0)((o=(0,n.A)((function*(e,t,a){var n=(yield r.getBookmarkData.call(t)).filter((function(e){return e.url!==a}));r.buildBookmarkData.call(t,n),r.syncBookmark.call(t,{url:a,isBookmark:!1})})),function(e,t,r){return o.apply(this,arguments)})),r.modifyBrowserBookmark=(0,a.q0)((s=(0,n.A)((function*(e,t,a){if(a.url&&a.url!==S.url){var n=(yield r.getBookmarkData.call(t)).map((function(e){return e.url===a.url?_objectSpread(_objectSpread({},e),a):e}));r.buildBookmarkData.call(t,n)}})),function(e,t,r){return s.apply(this,arguments)})),r.getHistoryData=(0,a.q0)((0,n.A)((function*(){var e;return null!=(e=(yield f.A.simpleDb.browserHistory.getRawData())?.data)?e:[]}))),r.buildHistoryData=(0,a.q0)((function(e,t,r){if(!Array.isArray(r))throw new Error("buildHistoryData: payload must be an array");f.A.simpleDb.browserHistory.setRawData({data:r})})),r.addBrowserHistory=(0,a.q0)((u=(0,n.A)((function*(e,t,a){if(a.url&&a.url!==S.url){var n=(yield r.getHistoryData.call(t)).filter((function(e){return e.url!==a.url})),i={id:(0,D.lk)(),url:a.url,title:a.title,createdAt:Date.now()};r.buildHistoryData.call(t,[i,...n])}})),function(e,t,r){return u.apply(this,arguments)})),r.removeBrowserHistory=(0,a.q0)((c=(0,n.A)((function*(e,t,a){var n=(yield r.getHistoryData.call(t)).filter((function(e){return e.id!==a}));r.buildHistoryData.call(t,n)})),function(e,t,r){return c.apply(this,arguments)})),r.removeAllBrowserHistory=(0,a.q0)((d=(0,n.A)((function*(e,t){r.buildHistoryData.call(t,[])})),function(e,t){return d.apply(this,arguments)})),r.getWebTabById=(0,a.q0)((function(e,t,r){var n=e((0,a.GW)());return n?.[r||""]})),r.gotoSite=(0,a.q0)((b=(0,n.A)((function*(e,t,{id:a,url:n,title:i,favicon:o,isNewWindow:l,isInPlace:s,userTriggered:u}){var c=r.getWebTabById.call(t,null!=a?a:"");if(n){var d=h.Ay.validateUrl(n);if(!d)return;if(u&&r.addBrowserHistory.call(t,{url:d,title:null!=i?i:""}),"StandardBrowser"===v.n5)return(0,k.C)(d);var b=c?.id,p=!d.startsWith("http")&&"about:blank"!==d,f="boolean"==typeof l?l:(l||!b||"home"===b||p)&&"MultiTabBrowser"===v.n5,y=yield r.getBookmarkData.call(t),m=y?.some((function(e){return e.url.includes(d)}));return f?r.addWebTab.call(t,{title:i,url:d,favicon:o,isBookmark:m}):r.setWebTabData.call(t,{id:b,url:d,title:i,favicon:o,isBookmark:m}),f||s||(0,v.T0)({url:d,tabId:b}),p&&"MultiTabBrowser"===v.n5&&b&&setTimeout((function(){r.closeWebTab.call(t,b)}),1e3),!0}return!1})),function(e,t,r){return b.apply(this,arguments)})),r.openMatchDApp=(0,a.q0)((m=(0,n.A)((function*(e,t,{dApp:a,webSite:n,isNewWindow:i,tabId:o}){return n?r.gotoSite.call(t,{id:o,url:n.url,title:n.title,favicon:yield f.A.serviceDiscovery.buildWebsiteIconUrl(n.url),isNewWindow:i,userTriggered:!0}):a?r.gotoSite.call(t,{id:o,url:a.url,title:a.name,dAppId:a.dappId,favicon:a.logo||a.originLogo,userTriggered:!0,isNewWindow:i}):void 0})),function(e,t,r){return m.apply(this,arguments)})),r.handleOpenWebSite=(0,a.q0)((function(e,t,{useCurrentWindow:n,tabId:i,navigation:o,webSite:l,dApp:s,shouldPopNavigation:u=!0}){var c=!n;if(!n&&e((0,a.$D)()))return void p.Toast.message({title:w.a.intl.formatMessage({id:"msg__tab_has_reached_the_maximum_limit_of_str"},{0:"20"})});r.setDisplayHomePage.call(t,!1),r.openMatchDApp.call(t,{webSite:l,dApp:s,isNewWindow:c,tabId:i}),u&&o.pop()})),r.onNavigation=(0,a.q0)((function(e,t,{url:n,isNewWindow:i,isInPlace:o,title:l,favicon:s,canGoBack:u,canGoForward:c,loading:d,id:b,handlePhishingUrl:p}){var f=Date.now(),m=r.getWebTabById.call(t,null!=b?b:"");if(m){var k="string"==typeof n&&n!==m.url;if(n){var v=e((0,a.RY)()),{action:w}=h.Ay.parseDappRedirect(n,Array.from(v.keys()));if(w===h.Ay.EDAppOpenActionEnum.DENY)return void p?.(n);if(h.Ay.isValidDeepLink(n))return void(0,y.q)({url:n})}if(k){if(m.timestamp&&f-m.timestamp<500)return;if(B[m.id]&&n!==S.url&&f-B[m.id]<1e3)return;r.gotoSite.call(t,{url:n,title:l,favicon:s,isNewWindow:i,isInPlace:o,id:m.id})}r.setWebTabData.call(t,{id:m.id,title:l,favicon:s,canGoBack:u,canGoForward:c,loading:d})}})),r.addUrlToPhishingCache=(0,a.q0)((function(e,t,r){try{var{origin:n}=new URL(r.url),i=e((0,a.RY)());i.set(n,!0),t((0,a.RY)(),i),window.desktopApi?.setAllowedPhishingUrls(Array.from(i.keys()))}catch{}})),r.updateDappActivityInteraction=(0,a.q0)((function(e,t,r){var n=r.id;n||(n=e((0,a.WL)()));var i=n?v.O3[n]:null;if(i){var o="pause"===r.type;o?v.ay:v.F;i.jsBridge&&(i.jsBridge.globalOnMessageEnabled=!o)}})),r.pauseDappInteraction=(0,a.q0)((function(e,t,a){r.updateDappActivityInteraction.call(t,{id:a,type:"pause"})})),r.resumeDappInteraction=(0,a.q0)((function(e,t,a){r.updateDappActivityInteraction.call(t,{id:a,type:"resume"})})),r.validateWebviewSrc=(0,a.q0)((function(e,t,r){if(!r)return A.InvalidUrl;if(r===W)return A.Valid;var n=e((0,a.RY)()),{action:i}=h.Ay.parseDappRedirect(r,Array.from(n.keys()));return i===h.Ay.EDAppOpenActionEnum.DENY?A.NotSupportProtocol:h.Ay.containsPunycode(r)?A.InvalidPunycode:h.Ay.isValidDeepLink(r)?A.ValidDeeplink:A.Valid})),r}return(0,s.A)(ContextJotaiActionsDiscovery)}(m.x),I=(0,g.j)((function(){return console.log("new ContextJotaiActionsDiscovery()",Date.now()),new T}));function useBrowserTabActions(){var e=I(),t=e.addWebTab.use(),r=e.addBlankWebTab.use(),a=e.buildWebTabs.use(),n=e.refreshTabs.use(),i=e.setWebTabData.use(),o=e.getWebTabById.use(),l=e.closeWebTab.use(),s=e.closeAllWebTabs.use(),u=e.setCurrentWebTab.use(),c=e.setPinnedTab.use(),d=e.setDisplayHomePage.use();return(0,b.useRef)({addWebTab:t,addBlankWebTab:r,buildWebTabs:a,refreshTabs:n,setWebTabData:i,getWebTabById:o,closeWebTab:l,closeAllWebTabs:s,setCurrentWebTab:u,setPinnedTab:c,setDisplayHomePage:d})}function useBrowserBookmarkAction(){var e=I(),t=e.buildBookmarkData.use(),r=e.getBookmarkData.use(),a=e.addBrowserBookmark.use(),n=e.removeBrowserBookmark.use(),i=e.modifyBrowserBookmark.use();return(0,b.useRef)({buildBookmarkData:t,getBookmarkData:r,addBrowserBookmark:a,removeBrowserBookmark:n,modifyBrowserBookmark:i})}function useBrowserHistoryAction(){var e=I(),t=e.buildHistoryData.use(),r=e.getHistoryData.use(),a=e.addBrowserHistory.use(),n=e.removeBrowserHistory.use(),i=e.removeAllBrowserHistory.use();return(0,b.useRef)({buildHistoryData:t,getHistoryData:r,addBrowserHistory:a,removeBrowserHistory:n,removeAllBrowserHistory:i})}function useBrowserAction(){var e=I(),t=e.gotoSite.use(),r=e.openMatchDApp.use(),a=e.handleOpenWebSite.use(),n=e.onNavigation.use(),i=e.addUrlToPhishingCache.use(),o=e.pauseDappInteraction.use(),l=e.resumeDappInteraction.use(),s=e.validateWebviewSrc.use();return(0,b.useRef)({gotoSite:t,openMatchDApp:r,handleOpenWebSite:a,onNavigation:n,addUrlToPhishingCache:i,pauseDappInteraction:o,resumeDappInteraction:l,validateWebviewSrc:s})}},186890:(e,t,r)=>{r.r(t),r.d(t,{default:()=>v});var a=r(586330),n=r(514041),i=r(728234),o=r(728046),l=r(490343),s=r(310955),u=r(791088),c=r(498356),d=r(911998),b=r(567967),p=r(730223),f=r(564452),y=r(831085);function DappSearchModalSectionHeader({title:e,onMorePress:t}){return(0,y.jsxs)(l.XStack,{px:"$5",pb:"$2",alignItems:"center",justifyContent:"space-between",children:[(0,y.jsx)(l.Heading,{size:"$headingMd",children:e}),(0,y.jsx)(l.Button,{variant:"tertiary",size:"medium",onPress:t,children:"See All"})]})}var m="SEARCH_ITEM_ID",k=(0,y.jsx)(l.Image.Loading,{children:(0,y.jsx)(l.Skeleton,{width:"100%",height:"100%"})});const v=(0,f.k)((function SearchModal(){var e,t,r,f=(0,c.A)(),v=(0,i.lq)(),{useCurrentWindow:w,tabId:g,url:D=""}=null!=(e=v.params)?e:{},[h,A]=(0,n.useState)(D),{handleOpenWebSite:B}=(0,b.yZ)().current,{serviceDiscovery:W}=s.A,{result:S,run:T}=(0,d.yk)((0,a.A)((function*(){return{bookmarkData:yield W.getBookmarkData({generateIcon:!0,sliceCount:8}),historyData:yield W.getHistoryData({generateIcon:!0,sliceCount:8,keyword:null!=h?h:void 0})}})),[W,h]),{result:I}=(0,d.yk)((0,a.A)((function*(){return yield W.searchDApp(h)})),[h,W]),P=(0,n.useRef)(!1);(0,i.xK)((function(){P.current&&(setTimeout((function(){T()}),300),P.current=!1)}));var[j,x]=(0,n.useState)([]);(0,n.useEffect)((function(){(0,a.A)((function*(){if(h){var e=yield s.A.serviceDiscovery.buildWebsiteIconUrl("https://google.com");x([{dappId:m,name:`Search "${h}"`,url:"",logo:e},...null!=I?I:[]])}else x([])}))()}),[h,I]);var O=Array.isArray(j)&&j.length>0,H=(null!=(t=S?.bookmarkData)?t:[]).length>0&&!O,C=(null!=(r=S?.historyData)?r:[]).length>0,q=(0,n.useCallback)((function(e){return e.map((function(e,t){return(0,y.jsx)(u.c,{avatarProps:{src:e.logo||e.originLogo,loading:k,fallbackProps:{bg:"$bgStrong",justifyContent:"center",alignItems:"center",children:(0,y.jsx)(l.Icon,{name:"GlobusOutline"})}},renderItemText:function(){return(0,y.jsx)(l.RichSizeableText,{linkList:[{}],numberOfLines:1,size:"$bodyLgMedium",children:e?.keyword?e.name.replace(new RegExp(e.keyword,"ig"),`<a>${e.keyword}</a>`):e.name})},subtitleProps:{numberOfLines:1},onPress:function(){e.dappId===m?B({navigation:f,useCurrentWindow:w,tabId:g,webSite:{url:h,title:h}}):B({navigation:f,useCurrentWindow:w,tabId:g,dApp:e})},testID:`dapp-search${t}`},t)}))}),[B,f,h,g,w]);return(0,y.jsxs)(l.Page,{safeAreaEnabled:!0,children:[(0,y.jsx)(l.Page.Header,{headerTitle:"Search"}),(0,y.jsxs)(l.Page.Body,{children:[(0,y.jsx)(l.Stack,{mx:"$4",children:(0,y.jsx)(l.SearchBar,{autoFocus:!0,zIndex:20,selectTextOnFocus:!0,value:h,onSearchTextChange:A,onSubmitEditing:function(){B({navigation:f,useCurrentWindow:w,tabId:g,webSite:{url:h,title:h}})}})}),(0,y.jsxs)(l.ScrollView,{pt:"$2",pb:"$5",keyboardDismissMode:"none",keyboardShouldPersistTaps:"handled",onScrollBeginDrag:o.A.dismiss,children:[O?q(j):null,H?(0,y.jsxs)(l.Stack,{children:[(0,y.jsx)(DappSearchModalSectionHeader,{title:"Bookmarks",onMorePress:function(){P.current=!0,f.pushModal(p.ry.DiscoveryModal,{screen:p.v1.BookmarkListModal})}}),(0,y.jsx)(l.XStack,{children:S?.bookmarkData?.map((function(e,t){return(0,y.jsxs)(l.Stack,{flexBasis:"25%",alignItems:"center",py:"$2",$gtMd:{flexBasis:"16.66666667%"},onPress:function(){B({navigation:f,useCurrentWindow:w,tabId:g,webSite:{url:e.url,title:e.title}})},children:[(0,y.jsx)(l.Image,{w:"$14",h:"$14",borderRadius:"$3",children:(0,y.jsx)(l.Image.Source,{source:{uri:e.logo}})}),(0,y.jsx)(l.SizableText,{mt:"$2",px:"$2",size:"$bodyLgMedium",textAlign:"center",$gtMd:{size:"$bodyMdMedium"},numberOfLines:1,children:e.title})]},t)}))})]}):null,C?(0,y.jsxs)(l.Stack,{pt:"$5",children:[(0,y.jsx)(DappSearchModalSectionHeader,{title:"History",onMorePress:function(){P.current=!0,f.pushModal(p.ry.DiscoveryModal,{screen:p.v1.HistoryListModal})}}),S?.historyData.map((function(e,t){return(0,y.jsx)(u.c,{avatarProps:{src:e.logo,loading:k,fallbackProps:{bg:"$bgStrong",justifyContent:"center",alignItems:"center",children:(0,y.jsx)(l.Icon,{name:"GlobusOutline"})}},title:e.title,titleMatch:e.titleMatch,titleProps:{numberOfLines:1},subtitle:e.url,subTitleMatch:e.urlMatch,subtitleProps:{numberOfLines:1},testID:`search-modal-${e.title.toLowerCase()}`,onPress:function(){B({navigation:f,useCurrentWindow:w,tabId:g,webSite:{url:e.url,title:e.title}})}},t)}))]}):null]})]})]})}))},660015:(e,t,r)=>{r.d(t,{F:()=>l,O3:()=>i,T0:()=>crossWebviewLoadUrl,ay:()=>o,n5:()=>n});var a=r(663522),n="StandardBrowser",i={};function getWebviewWrapperRef(e){var t=e?i[e]:null;return null!=t?t:null}function crossWebviewLoadUrl({url:e,tabId:t}){var r=getWebviewWrapperRef(t);console.log("crossWebviewLoadUrl >>>>",e),a.Ay.isRuntimeBrowser?r?.innerRef?.loadURL(e):r?.innerRef?.loadUrl(e)}var o="\n(function(){\n  if (window.WebSocket) {\n    if (!window.$$onekeyWebSocketSend) {\n      window.$$onekeyWebSocketSend = window.WebSocket.prototype.send;\n    }\n    window.WebSocket.prototype.send = () => {};\n  }\n})()\n",l="\n(function(){\n  if (\n    window.WebSocket &&\n    window.$$onekeyWebSocketSend\n  ) {\n    window.WebSocket.prototype.send = window.$$onekeyWebSocketSend;\n  }\n})()\n"}}]);