"use strict";(self.webpackChunkweb=self.webpackChunkweb||[]).push([[51972],{278484:(e,n,t)=>{t.d(n,{wI:()=>DAppAccountListItem,ZY:()=>DAppAccountListStandAloneItem,X1:()=>DAppAccountListStandAloneItemForHomeScene,VV:()=>WalletConnectAccountTriggerList});var o=t(460986),c=t.n(o),r=t(586330),i=t(514041),s=t(17617),a=t(490343),l=t(310955),u=t(325809),d=t(237532),p=t(24284),m=t(911998),g=t(162616),h=t(226952),A=t(584186),f=t(714191),x=t(82506);var y=t(831085);function DAppAccountListInitFromHome({num:e}){var n=(0,g.z$)();return(0,i.useEffect)((function(){(0,r.A)((function*(){yield A.A.wait(600),yield n.current.syncFromScene({from:{sceneName:f.Zs.home,sceneNum:0},num:e})}))()}),[n,e]),null}function DAppAccountListItem({num:e,handleAccountChanged:n,readonly:t,networkReadonly:o,compressionUiMode:c,initFromHome:r,beforeShowTrigger:l}){!function useHandleDiscoveryAccountChanged({num:e,handleAccountChanged:n}){var{activeAccount:t}=(0,g.LH)({num:e}),{selectedAccount:o}=(0,g.wz)({num:e}),c=(0,x.d)(t,200),r=(0,x.d)(o,200),s=(0,i.useRef)(t),a=(0,i.useRef)(o);(0,i.useEffect)((function(){s.current=t,a.current=o}),[t,o]),(0,i.useEffect)((function(){n&&(c.isOthersWallet&&c.account?.id===r.othersWalletAccountId||c.indexedAccount?.id===r.indexedAccountId)&&n({activeAccount:s.current,selectedAccount:a.current},e)}),[c,r,n,e])}({num:e,handleAccountChanged:n});var p=r&&!t,m=p?800:500;return(0,y.jsxs)(y.Fragment,{children:[(0,y.jsxs)(a.XGroup,{bg:"$bg",borderRadius:"$3",borderColor:"$borderSubdued",borderWidth:s.A.hairlineWidth,separator:(0,y.jsx)(a.Divider,{vertical:!0}),disabled:t,children:[(0,y.jsx)(a.Group.Item,{children:(0,y.jsx)(u.jY,{num:e,beforeShowTrigger:l,disabled:o||t,loadingDuration:m})}),(0,y.jsx)(a.Group.Item,{children:(0,y.jsx)(d.U,{num:e,compressionUiMode:c,beforeShowTrigger:l,loadingDuration:m})})]}),p?(0,y.jsx)(DAppAccountListInitFromHome,{num:e}):null]})}function DAppAccountListStandAloneItem({readonly:e,handleAccountChanged:n,onConnectedAccountInfoChanged:t}){var{serviceDApp:o,serviceNetwork:s}=l.A,{$sourceInfo:d}=(0,p.A)(),{result:g}=(0,m.yk)((0,r.A)((function*(){var e,n;if(!d?.origin||!d.scope)return{accountSelectorNum:null,networkIds:null};var t=(0,h.zg)(d.scope),c=t?(yield s.getNetworkIdsByImpls({impls:t})).networkIds:null,r=yield o.getConnectedAccountsInfo({origin:d.origin,scope:null!=(e=d.scope)?e:"",isWalletConnectRequest:d.isWalletConnectRequest});return Array.isArray(r)&&r.length>0&&"number"==typeof r[0]?.num?{accountSelectorNum:r[0].num,networkIds:c,existConnectedAccount:!0}:{accountSelectorNum:yield o.getAccountSelectorNum({origin:d.origin,scope:null!=(n=d.scope)?n:"",isWalletConnectRequest:d.isWalletConnectRequest}),networkIds:c,existConnectedAccount:!1}})),[d?.origin,d?.scope,d?.isWalletConnectRequest,o,s]);return(0,i.useEffect)((function(){c()(g?.accountSelectorNum)&&t&&t({num:g.accountSelectorNum,existConnectedAccount:g.existConnectedAccount})}),[g?.accountSelectorNum,g?.existConnectedAccount,t]),(0,y.jsxs)(a.YStack,{space:"$2",testID:"DAppAccountListStandAloneItem",children:[(0,y.jsx)(a.SizableText,{size:"$headingMd",color:"$text",children:"Accounts"}),"number"==typeof g?.accountSelectorNum&&Array.isArray(g?.networkIds)?(0,y.jsx)(u.b8,{config:{sceneName:f.Zs.discover,sceneUrl:d?.origin},enabledNum:[g.accountSelectorNum],availableNetworksMap:{[g.accountSelectorNum]:{networkIds:g.networkIds}},children:(0,y.jsx)(DAppAccountListItem,{initFromHome:!g?.existConnectedAccount,num:g?.accountSelectorNum,handleAccountChanged:n,readonly:e})}):null]})}function DAppAccountListStandAloneItemForHomeScene(){return(0,y.jsxs)(a.YStack,{space:"$2",testID:"DAppAccountListStandAloneItem",children:[(0,y.jsx)(a.SizableText,{size:"$headingMd",color:"$text",children:"Accounts"}),(0,y.jsx)(u.b8,{config:{sceneName:f.Zs.home},enabledNum:[0],children:(0,y.jsx)(DAppAccountListItem,{initFromHome:!1,num:0,readonly:!0})})]})}function WalletConnectAccountTriggerList({sceneUrl:e,sessionAccountsInfo:n,handleAccountChanged:t}){var o=n.map((function(e){return e.accountSelectorNum})),c=n.reduce((function(e,n){var t=n.networkIds.filter(Boolean);return e[n.accountSelectorNum]={networkIds:t,defaultNetworkId:t[0]},e}),{});return(0,y.jsxs)(a.YStack,{space:"$2",children:[(0,y.jsx)(a.SizableText,{size:"$headingMd",color:"$text",children:"Accounts"}),Array.isArray(n)&&n.length?(0,y.jsx)(u.b8,{config:{sceneName:f.Zs.discover,sceneUrl:e},enabledNum:o,availableNetworksMap:c,children:(0,y.jsx)(a.YStack,{space:"$2",children:n.map((function(e){return(0,y.jsx)(a.Stack,{children:(0,y.jsx)(DAppAccountListItem,{initFromHome:!0,num:e.accountSelectorNum,handleAccountChanged:t})},e.accountSelectorNum)}))})}):null]})}},980342:(e,n,t)=>{t.d(n,{A:()=>r});var o=t(490343),c=t(831085);const r=function DappOpenModalPage({children:e,onClose:n,dappApprove:t}){return(0,c.jsxs)(o.Page,{scrollEnabled:!0,onClose:function(e){e||t.reject(),"function"==typeof n&&n(e)},children:[(0,c.jsx)(o.Page.Header,{headerShown:!1}),e]})}},851972:(e,n,t)=>{t.r(n),t.d(n,{default:()=>x});var o=t(586330),c=t(514041),r=t(908867),i=t(490343),s=function(e){return e[e.Metadata=0]="Metadata",e[e.Text=1]="Text",e[e.RelayRec=2]="RelayRec",e[e.Contacts=3]="Contacts",e[e.DM=4]="DM",e[e.Deleted=5]="Deleted",e[e.Reaction=7]="Reaction",e[e.BadgeAward=8]="BadgeAward",e[e.ChannelCreation=40]="ChannelCreation",e[e.ChannelMetadata=41]="ChannelMetadata",e[e.ChannelMessage=42]="ChannelMessage",e[e.ChannelHideMessage=43]="ChannelHideMessage",e[e.Reporting=1984]="Reporting",e[e.ZapRequest=9734]="ZapRequest",e[e.Zap=9735]="Zap",e[e.RelayListMetadata=10002]="RelayListMetadata",e[e.ClientAuthentication=22242]="ClientAuthentication",e[e.NostrConnect=24133]="NostrConnect",e[e.ProfileBadges=30008]="ProfileBadges",e[e.BadgeDefinition=30009]="BadgeDefinition",e[e.LongFormContent=30023]="LongFormContent",e[e.ApplicationSpecificData=30078]="ApplicationSpecificData",e}({}),a=Object.values(s),l=function(e){return e.signEvent="signEvent",e.signSchnorr="signSchnorr",e.encrypt="encrypt",e.decrypt="decrypt",e}({}),u=t(310955),d=t(796895),p=t(24284),m=t(278484),g=t(748032),h=t(905710),A=t(980342),f=t(831085);const x=function NostrSignEventModal(){var e,n,t,x,{$sourceInfo:y,event:C,pubkey:S,plaintext:b,ciphertext:v,sigHash:I,walletId:k,accountId:w,networkId:j}=(0,p.A)(),N=(0,d.A)({id:null!=(e=y?.id)?e:"",closeWindowAfterResolved:!0}),{showContinueOperate:M,continueOperate:_,setContinueOperate:D,riskLevel:L,urlSecurityInfo:R}=(0,h.q)({origin:null!=(n=y?.origin)?n:""}),$=(0,r.A)(),[H,E]=(0,c.useState)(!1),[T,F]=(0,c.useState)(!1),[O,P]=(0,c.useState)(!1),B=(0,c.useMemo)((function(){return C?l.signEvent:I?l.signSchnorr:S&&b?l.encrypt:S&&v?l.decrypt:void 0}),[S,b,C,v,I]),W=(0,c.useMemo)((function(){var e;return B===l.encrypt?b:B===l.decrypt?v:B===l.signSchnorr?I:null!=(e=C?.content)?e:`(${$.formatMessage({id:"msg__no_content"})})`}),[B,C,b,v,I,$]),z=(0,c.useMemo)((function(){return B!==l.signEvent?"":a.includes(Number(C?.kind))?$.formatMessage({id:`msg__nostr_event_kind_${null!=(e=C?.kind)?e:"unknown"}`}):$.formatMessage({id:"msg__nostr_event_kind_unknown"},{kind:C?.kind});var e}),[$,B,C]),Z=(0,c.useMemo)((function(){return B===l.encrypt?$.formatMessage({id:"msg__nostr_allow_website_to_encrypt_data"}):B===l.decrypt?$.formatMessage({id:"msg__nostr_allow_website_to_decrypt_data"}):$.formatMessage({id:"msg__allow_sign_event"},{kind:z})}),[$,B,z]),q=(0,c.useCallback)((x=(0,o.A)((function*(e){try{var n,{serviceNostr:t,servicePassword:o}=u.A;P(!0),(yield o.getCachedPassword())||(yield o.promptPasswordVerifyByAccount({accountId:w})),B===l.signEvent?n=yield t.signEvent({event:null!=C?C:{},walletId:k,accountId:w,networkId:j}):B===l.encrypt?n=yield t.encrypt({pubkey:null!=S?S:"",plaintext:null!=b?b:"",walletId:k,accountId:w,networkId:j}):B===l.decrypt?n=yield t.decrypt({pubkey:null!=S?S:"",ciphertext:null!=v?v:"",walletId:k,accountId:w,networkId:j}):B===l.signSchnorr&&(n=yield t.signSchnorr({sigHash:null!=I?I:"",walletId:k,accountId:w,networkId:j})),console.log("====> result: ",n),setTimeout((function(){var t;N.resolve({result:null!=(t=n?.data)?t:null,close:e})}),300)}catch(e){N.reject()}finally{P(!1)}})),function(e){return x.apply(this,arguments)}),[C,B,k,w,j,N,S,b,v,I]),Y=(0,c.useCallback)((function(){return C?(0,f.jsxs)(f.Fragment,{children:[(0,f.jsx)(i.Button,{variant:"secondary",onPress:function(){return E(!H)},children:H?"隐藏完整消息":"查看完整消息"}),H?(0,f.jsx)(i.TextArea,{my:"$2",disabled:!0,editable:!1,numberOfLines:14,children:JSON.stringify(C,null,2)}):null]}):null}),[C,H]),[U,G]=(0,c.useState)(null),V=(0,c.useMemo)((function(){return B===l.signEvent&&Number(C?.kind)===s.DM}),[B,C]);(0,c.useEffect)((function(){V&&C?.content&&u.A.serviceNostr.getEncryptedData(C?.content).then((function(e){e&&e.plaintext&&G(e.plaintext)}))}),[C,V]);var J=(0,c.useCallback)((function(){return V&&U&&U.length>0?(0,f.jsxs)(i.YStack,{space:"$2",children:[(0,f.jsxs)(i.SizableText,{children:[$.formatMessage({id:"form__nostr_plaintext"}),":"]}),(0,f.jsx)(i.TextArea,{disabled:!0,editable:!1,numberOfLines:2,children:U})]}):null}),[$,U,V]);return(0,f.jsx)(A.A,{dappApprove:N,children:(0,f.jsxs)(f.Fragment,{children:[(0,f.jsx)(i.Page.Header,{headerShown:!1}),(0,f.jsx)(i.Page.Body,{children:(0,f.jsxs)(g.HJ,{title:"Message Signature Request",subtitle:Z,origin:null!=(t=y?.origin)?t:"",urlSecurityInfo:R,children:[(0,f.jsx)(m.ZY,{readonly:!0}),(0,f.jsxs)(i.YStack,{space:"$2",children:[(0,f.jsx)(i.SizableText,{children:z}),(0,f.jsx)(i.TextArea,{disabled:!0,editable:!1,numberOfLines:2,children:W}),J(),Y()]}),B===l.signEvent?(0,f.jsx)(i.Checkbox,{label:"记住我的选择，不再提示",value:T,onChange:function(e){return F(!!e)}}):null]})}),(0,f.jsx)(i.Page.Footer,{children:(0,f.jsx)(g.OS,{continueOperate:_,setContinueOperate:function(e){D(!!e)},onConfirm:q,onCancel:function(){return N.reject()},confirmButtonProps:{loading:O,disabled:!_},showContinueOperateCheckbox:M,riskLevel:L})})]})})}}}]);